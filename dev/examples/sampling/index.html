<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Inference and Sampler Tuning · OdeMMHPlanner.jl</title><meta name="title" content="Inference and Sampler Tuning · OdeMMHPlanner.jl"/><meta property="og:title" content="Inference and Sampler Tuning · OdeMMHPlanner.jl"/><meta property="twitter:title" content="Inference and Sampler Tuning · OdeMMHPlanner.jl"/><meta name="description" content="Documentation for OdeMMHPlanner.jl."/><meta property="og:description" content="Documentation for OdeMMHPlanner.jl."/><meta property="twitter:description" content="Documentation for OdeMMHPlanner.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="OdeMMHPlanner.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">OdeMMHPlanner.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Examples</span><ul><li class="is-active"><a class="tocitem" href>Inference and Sampler Tuning</a><ul class="internal"><li><a class="tocitem" href="#Problem-Setting"><span>Problem Setting</span></a></li><li><a class="tocitem" href="#Setup-and-Data-Generation"><span>Setup and Data Generation</span></a></li><li><a class="tocitem" href="#ODE-Solver-Configuration"><span>ODE Solver Configuration</span></a></li><li><a class="tocitem" href="#Prior-Specification"><span>Prior Specification</span></a></li><li><a class="tocitem" href="#Running-the-MMH-Sampler"><span>Running the MMH Sampler</span></a></li><li><a class="tocitem" href="#Diagnostics-and-Sampler-Assessment"><span>Diagnostics and Sampler Assessment</span></a></li></ul></li><li><a class="tocitem" href="../control/">Optimal Control</a></li></ul></li><li><a class="tocitem" href="../../experiments/">Experiments</a></li><li><a class="tocitem" href="../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Inference and Sampler Tuning</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Inference and Sampler Tuning</a></li></ul></nav><div class="docs-right"><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="sampling"><a class="docs-heading-anchor" href="#sampling">Inference and Sampler Tuning</a><a id="sampling-1"></a><a class="docs-heading-anchor-permalink" href="#sampling" title="Permalink"></a></h1><p>This example demonstrates how to perform <strong>Bayesian inference with the Marginal Metropolis–Hastings (MMH) sampler</strong> with ODE-integrated latent trajectories, and how to tune the sampler for reliable posterior exploration. Proper tuning is essential for efficient mixing and for obtaining posterior samples that are suitable for downstream planning and control.</p><p>The complete, executable script corresponding to this section is available at <code>experiments/sampler_tuning.jl</code>.</p><h2 id="Problem-Setting"><a class="docs-heading-anchor" href="#Problem-Setting">Problem Setting</a><a id="Problem-Setting-1"></a><a class="docs-heading-anchor-permalink" href="#Problem-Setting" title="Permalink"></a></h2><p>We consider a continuous-time <strong>dynamical system with unknown parameters and latent states, observed through infrequent and noisy output measurements</strong>. In this example, the system is a glucose–insulin model for a patient with type-1 diabetes.</p><p>Assumptions in the example:</p><ul><li>The structure of the dynamics is known.</li><li>A subset of model parameters and the initial latent state are unknown.</li><li>Only noisy measurements of the output are available (no full state measurements).</li><li>Measurements are available only at discrete, irregular time instants.</li></ul><p>The goal of inference is to obtain samples from the <strong>posterior distribution over unknown parameters and latent state trajectories</strong> that are consistent with the observed input–output data.</p><h2 id="Setup-and-Data-Generation"><a class="docs-heading-anchor" href="#Setup-and-Data-Generation">Setup and Data Generation</a><a id="Setup-and-Data-Generation-1"></a><a class="docs-heading-anchor-permalink" href="#Setup-and-Data-Generation" title="Permalink"></a></h2><p>The script defines the glucose–insulin dynamics and generates synthetic data to mimic a realistic learning scenario. The training set consists of sparse glucose measurements over a 12-hour window; additional measurements are retained as a test set for posterior validation.</p><p>The full model definition is available in the script.</p><h2 id="ODE-Solver-Configuration"><a class="docs-heading-anchor" href="#ODE-Solver-Configuration">ODE Solver Configuration</a><a id="ODE-Solver-Configuration-1"></a><a class="docs-heading-anchor-permalink" href="#ODE-Solver-Configuration" title="Permalink"></a></h2><p>The MMH sampler embeds a numerical ODE solver to propagate candidate dynamics between measurement times. Any solver from <code>DifferentialEquations.jl</code> can be used.</p><ul><li><strong>For control</strong>: the fixed-step solver <code>RK4()</code> is recommended for consistency with the optimal control formulation.</li><li><strong>For long trajectories or fine resolutions</strong>: variable-step solvers with appropriate tolerances can significantly reduce runtime.</li></ul><pre><code class="language-julia hljs">using DifferentialEquations

rk4_step_size = 0.5 # step size for RK4 solver
ODE_solver = RK4() # ODE solver algorithm
ODE_solver_opts = (dt=rk4_step_size, adaptive=false) # ODE solver options</code></pre><h2 id="Prior-Specification"><a class="docs-heading-anchor" href="#Prior-Specification">Prior Specification</a><a id="Prior-Specification-1"></a><a class="docs-heading-anchor-permalink" href="#Prior-Specification" title="Permalink"></a></h2><p>Prior selection is a critical part of tuning: it incorporates domain knowledge and restricts the region of parameter space explored by the sampler.</p><ul><li>Overly broad priors can lead to slow convergence and poor mixing.</li><li>Overly restrictive priors can bias the inference and prevent recovery of plausible models.</li></ul><p>In this example:</p><ul><li>Unknown parameters are modeled on a log scale to enforce positivity.</li><li>Log-normal priors are chosen such that most probability mass lies within physically plausible ranges reported in the literature.</li></ul><pre><code class="language-julia hljs">const theta_mean = [
    -4.26,      # log(p2)
    -13.27,     # log(p3)
    -1.66       # log(n)
]

const theta_var = [
    0.18^2,
    0.28^2,
    0.23^2
]</code></pre><p>A Gaussian prior is also assumed for the initial latent state, centered near a basal equilibrium with moderate variance.</p><h2 id="Running-the-MMH-Sampler"><a class="docs-heading-anchor" href="#Running-the-MMH-Sampler">Running the MMH Sampler</a><a id="Running-the-MMH-Sampler-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-MMH-Sampler" title="Permalink"></a></h2><p>We employ a <strong>staged MMH strategy</strong>, which incrementally increases the amount of data used during sampling. This helps the sampler locate high-probability regions of the posterior before long runs are used for uncertainty quantification.</p><h3 id="Key-tuning-parameters"><a class="docs-heading-anchor" href="#Key-tuning-parameters">Key tuning parameters</a><a id="Key-tuning-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Key-tuning-parameters" title="Permalink"></a></h3><p><strong>Staged refinement:</strong></p><ul><li><code>M_chunk</code>: number of measurements added per stage</li><li><code>K_stage</code>: number of samples drawn per stage</li><li><code>alpha</code>: proposal covariance scaling (target acceptance rate ≈ 25%)</li></ul><p><strong>Final sampling:</strong></p><ul><li><code>K</code>: total number of samples</li><li><code>k_d</code>: thinning factor (used to reduce autocorrelation)</li></ul><pre><code class="language-julia hljs">MMH_samples, acceptance_ratio, runtime = staged_ODE_MMH(
    # data, model, and prior definitions
)</code></pre><h3 id="Practical-tuning-guidance:"><a class="docs-heading-anchor" href="#Practical-tuning-guidance:">Practical tuning guidance:</a><a id="Practical-tuning-guidance:-1"></a><a class="docs-heading-anchor-permalink" href="#Practical-tuning-guidance:" title="Permalink"></a></h3><ul><li>If the acceptance ratio is far from ≈25%, adjust <code>alpha</code> (increase it if acceptance is too high; decrease it if acceptance is too low).</li><li>If chains mix poorly (high autocorrelation, sticky traces), increase <code>K_stage</code> and/or reduce <code>M_chunk</code>.</li></ul><h2 id="Diagnostics-and-Sampler-Assessment"><a class="docs-heading-anchor" href="#Diagnostics-and-Sampler-Assessment">Diagnostics and Sampler Assessment</a><a id="Diagnostics-and-Sampler-Assessment-1"></a><a class="docs-heading-anchor-permalink" href="#Diagnostics-and-Sampler-Assessment" title="Permalink"></a></h2><p>After sampling, it is essential to verify that the chain has mixed well and provides reliable posterior samples.</p><h3 id="Trace-Plots"><a class="docs-heading-anchor" href="#Trace-Plots">Trace Plots</a><a id="Trace-Plots-1"></a><a class="docs-heading-anchor-permalink" href="#Trace-Plots" title="Permalink"></a></h3><p>Trace plots should appear approximately stationary after burn-in, without long-term trends, and should show reasonable jump sizes. Persistent drift or long plateaus typically indicate insufficient mixing or overly aggressive proposals.</p><h3 id="Autocorrelation-and-ESS"><a class="docs-heading-anchor" href="#Autocorrelation-and-ESS">Autocorrelation and ESS</a><a id="Autocorrelation-and-ESS-1"></a><a class="docs-heading-anchor-permalink" href="#Autocorrelation-and-ESS" title="Permalink"></a></h3><p>The autocorrelation function (ACF) reveals the dependence between consecutive samples, while the effective sample size (ESS) summarizes how many effectively independent samples are available.</p><pre><code class="language-julia hljs">autocorrelation = compute_autocorrelation(MMH_samples; max_lag=50)
ess = compute_ess(MMH_samples; max_lag=100)</code></pre><p><img src="../../assets/autocorrelation.svg" alt="autocorrelation"/></p><p>A well-mixed chain exhibits rapidly decaying autocorrelation across all parameters and latent states. If autocorrelation remains high at large lags, this indicates poor mixing and suggests adjusting the proposal scaling (<code>alpha</code>), increasing the number of samples per stage (<code>K_stage</code>), or reducing the amount of data added per stage (<code>M_chunk</code>).</p><p>A key tuning objective is to maximize ESS per unit time, while obtaining approximately independent samples.</p><h3 id="Posterior-Validation"><a class="docs-heading-anchor" href="#Posterior-Validation">Posterior Validation</a><a id="Posterior-Validation-1"></a><a class="docs-heading-anchor-permalink" href="#Posterior-Validation" title="Permalink"></a></h3><p>Posterior samples are validated by simulating the system forward and comparing predictions to held-out test data.</p><p><img src="../../assets/prediction.svg" alt="prediction"/></p><p>The posterior mean should track the test trajectory reasonably well, while the prediction band reflects uncertainty arising from sparse and noisy measurements.</p><p>Qualitative indicators of a well-calibrated posterior include:</p><ul><li>good agreement between posterior mean and test data,</li><li>uncertainty bands that neither collapse prematurely nor grow excessively wide.</li></ul><p>If these conditions are not met, revisit prior specification and sampler tuning before proceeding to optimal control.</p><p>If they are satisfied, the inferred posterior models are suitable for downstream control tasks.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">« Home</a><a class="docs-footer-nextpage" href="../control/">Optimal Control »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Wednesday 7 January 2026 19:04">Wednesday 7 January 2026</span>. Using Julia version 1.12.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
